package com.dnf.web;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.dnf.dto.CustMsg;
import com.dnf.entity.CustAmount;
import com.dnf.entity.CustInfo;
import com.dnf.entity.Customer;
import com.dnf.service.CustomerService;
import com.dnf.utils.CSRFToken;
import com.dnf.utils.RegExputils;
import com.dnf.utils.Result;
import com.dnf.utils.VerifyCodeUtils;

@Controller
@RequestMapping("/")
public class LoginController {
	
	private Logger logger = LoggerFactory.getLogger(this.getClass());
	
	@Autowired
	private CustomerService custService;
	
	@RequestMapping("/login")
	public String loginPage(HttpServletRequest request){
		return "login";
	}
	
	@RequestMapping(value="/login.action", method=RequestMethod.POST)
	@ResponseBody
	public Result login(HttpServletRequest request){
//		校验token
		if(!CSRFToken.checkToken(request)){
			return new Result(false, "您的操作过于频繁，请刷新页面");
		}
		
		//校验手机号码格式
		String phoneNum = (String) request.getParameter("phone_num");
		String password = (String) request.getParameter("password");
		if(!RegExputils.regexPhoneNum(phoneNum)){
			return new Result(false, "手机号码格式错误");
		}
		
		Customer customer = custService.queryByPhoneNum(phoneNum);
		if(customer != null){
			logger.info("登录查询customer：" + customer.toString());
			if(password.equals(customer.getPassword())){
				request.getSession().setAttribute("customer", customer);
//				校验用户是否填写个人信息
				CustInfo info = custService.query4CustInfoByPhoneNum(phoneNum);
				if(info != null){
					logger.info("用户：" + phoneNum + "已经填写个人信息" );
					request.getSession().setAttribute("custInfo", info);
//					获取用户账户
					CustAmount amount = custService.query4CustAmountByPhoneNum(phoneNum);
					logger.info("用户：" + phoneNum + "的账户:" + amount.toString());
					CustMsg customerMsg = new CustMsg(customer, info, amount);
					request.getSession().setAttribute("customerMsg", customerMsg);
					return new Result<CustMsg>(true, customerMsg);
				}else{
					return new Result<Customer>(true, customer);
				}
			}else{
				return new Result(false, "密码错误");
			}
		}else {
			return new Result(false, "该用户不存在");
		}
	}
	
	@RequestMapping(value="/captcha", method=RequestMethod.GET)
	@ResponseBody
	public void getCaptcha(HttpServletRequest request, HttpServletResponse response){
		response.setHeader("Pragma", "No-cache");  
        response.setHeader("Cache-Control", "no-cache");  
        response.setDateHeader("Expires", 0);  
        response.setContentType("image/jpeg");
      //生成随机字串  
        String verifyCode = VerifyCodeUtils.generateVerifyCode(4);  
        logger.info("生成的字符串" + verifyCode);
        //存入会话session  
        HttpSession session = request.getSession(true);  
        session.setAttribute("verifyCode", verifyCode.toLowerCase());  
        //生成图片  
        int w = 100, h = 40;  
        try{
        	VerifyCodeUtils.outputImage(w, h, response.getOutputStream(), verifyCode); 
        }catch(Exception e){
        	logger.error(e.getMessage());
        }
	}
	
	@RequestMapping(value="/checkCaptcha", method=RequestMethod.POST)
	@ResponseBody
	public Result checkCaptcha(HttpServletRequest request){
		String captcha = request.getParameter("captcha");
		logger.info("reqeust:" + captcha + "   session:" + request.getSession().getAttribute("verifyCode"));
		if(captcha != null){
			if(captcha.toLowerCase().equals(request.getSession().getAttribute("verifyCode"))){
				return new Result(true, null);
			}
		}
		return new Result(false, "验证码错误");
	}
	
	@RequestMapping(value="/main")
	public String MainPage(){
		return "main";
	}

}
